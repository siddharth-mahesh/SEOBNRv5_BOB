#include "mainv4pheader.h"
int v4P_compute_rhs(double t,const double values[],double dvalues[],double m1,double m2,int tortoise){
    double x = values[0];
    double y = values[1];
    double z = values[2];
    double p1star = values[3];
    double p2star = values[4];
    double p3star = values[5];
    double S1x = values[6];
    double S1y = values[7];
    double S1z = values[8];
    double S2x = values[9];
    double S2y = values[10];
    double S2z = values[11];
    double csi_and_dcsi[2] = {0.};
    double r = sqrt(x*x + y*y + z*z);
    double u = 1./r;
    double u2 = u*u;
    int success = v4P_compute_csi_dcsi(csi_and_dcsi,m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double csi = csi_and_dcsi[0];
    double dcsi = csi_and_dcsi[1];
    double csi_minus_one = csi - 1;
    double one_minus_inverse_csi = 1 - 1/csi;
    double T11_xderiv1 = u2*( 2*x*csi_minus_one + u*x*x*x*(dcsi - 2*csi_minus_one));
    double T11_xderiv2 = u2*( u*x*x*y*(dcsi - 2*csi_minus_one));
    double T11_xderiv3 = u2*( u*x*x*z*(dcsi - 2*csi_minus_one));
    double T12_xderiv1 = u2*( y*csi_minus_one + u*x*y*x*(dcsi - 2*csi_minus_one));
    double T12_xderiv2 = u2*( x*csi_minus_one + u*x*y*y*(dcsi - 2*csi_minus_one));
    double T12_xderiv3 = u2*( u*x*y*z*(dcsi - 2*csi_minus_one));
    double T13_xderiv1 = u2*( z*csi_minus_one + u*x*z*x*(dcsi - 2*csi_minus_one));
    double T13_xderiv2 = T12_xderiv3;
    double T13_xderiv3 = u2*( x*csi_minus_one + u*x*z*z*(dcsi - 2*csi_minus_one));
    double T21_xderiv1 = T12_xderiv1;
    double T21_xderiv2 = T12_xderiv2;
    double T21_xderiv3 = T12_xderiv3;
    double T22_xderiv1 = u2*( u*y*y*x*(dcsi - 2*csi_minus_one));
    double T22_xderiv2 = u2*( 2*y*csi_minus_one + u*y*y*y*(dcsi - 2*csi_minus_one));
    double T22_xderiv3 = u2*( u*y*y*z*(dcsi - 2*csi_minus_one));
    double T23_xderiv1 = T12_xderiv3;
    double T23_xderiv2 = u2*( z*csi_minus_one + u*y*z*y*(dcsi - 2*csi_minus_one));
    double T23_xderiv3 = u2*( y*csi_minus_one + u*y*z*z*(dcsi - 2*csi_minus_one));
    double T31_xderiv1 = T13_xderiv1;
    double T31_xderiv2 = T13_xderiv2;
    double T31_xderiv3 = T13_xderiv3;
    double T32_xderiv1 = T23_xderiv1;
    double T32_xderiv2 = T23_xderiv2;
    double T32_xderiv3 = T23_xderiv3;
    double T33_xderiv1 = u2*( u*z*z*x*(dcsi - 2*csi_minus_one));
    double T33_xderiv2 = u2*( u*z*z*y*(dcsi - 2*csi_minus_one));
    double T33_xderiv3 = u2*( 2*z*csi_minus_one + u*z*z*z*(dcsi - 2*csi_minus_one));
    double Tinv11 = 1 - x*x*one_minus_inverse_csi*u2;
    double Tinv12 = -y*x*one_minus_inverse_csi*u2;
    double Tinv13 = -z*x*one_minus_inverse_csi*u2;
    double Tinv21 = Tinv12;
    double Tinv22 = 1 - y*y*one_minus_inverse_csi*u2;
    double Tinv23 = -z*y*one_minus_inverse_csi*u2;
    double Tinv31 = Tinv13;
    double Tinv32 = Tinv23;
    double Tinv33 = 1 - z*z*one_minus_inverse_csi*u2;
    double T11 = 1 + x*x*csi_minus_one*u2;
    double T12 = x*y*csi_minus_one*u2;
    double T13 = x*z*csi_minus_one*u2;
    double T21 = T12;
    double T22 = 1 + y*y*csi_minus_one*u2;
    double T23 = y*z*csi_minus_one*u2;
    double T31 = T13;
    double T32 = T23;
    double T33 = 1 + z*z*csi_minus_one*u2;
    double eta = m1*m2/((m1 + m2)*(m1+m2));
    double p1 = Tinv11*p1star + Tinv13*p2star + Tinv13*p3star;
    double p2 = Tinv21*p1star + Tinv22*p2star + Tinv23*p3star;
    double p3 = Tinv31*p1star + Tinv32*p2star + Tinv33*p3star;
    double x_hamiltonian_deriv = ham_x_deriv(m1,m2,2,x,y,z,p1,p2,p3,S1x,S1y,S1z,S2x,S2y,S2z)/eta;
    double y_hamiltonian_deriv = ham_y_deriv(m1,m2,2,x,y,z,p1,p2,p3,S1x,S1y,S1z,S2x,S2y,S2z)/eta;
    double z_hamiltonian_deriv = ham_z_deriv(m1,m2,2,x,y,z,p1,p2,p3,S1x,S1y,S1z,S2x,S2y,S2z)/eta;
    double p1star_hamiltonian_deriv = ham_p1_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z)/eta;
    double p2star_hamiltonian_deriv = ham_p2_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z)/eta;
    double p3star_hamiltonian_deriv = ham_p3_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z)/eta;
    double S1x_hamiltonian_deriv = ham_S1x_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double S1y_hamiltonian_deriv = ham_S1y_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double S1z_hamiltonian_deriv = ham_S1z_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double S2x_hamiltonian_deriv = ham_S2x_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double S2y_hamiltonian_deriv = ham_S2y_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double S2z_hamiltonian_deriv = ham_S2z_deriv(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double z_time_deriv = T31*p1star_hamiltonian_deriv + T32*p2star_hamiltonian_deriv + T33*p3star_hamiltonian_deriv;
    double y_time_deriv = T21*p1star_hamiltonian_deriv + T22*p2star_hamiltonian_deriv + T23*p3star_hamiltonian_deriv;
    double x_time_deriv = T11*p1star_hamiltonian_deriv + T12*p2star_hamiltonian_deriv + T13*p3star_hamiltonian_deriv;
    double hamiltonian = v4P_compute_Hamiltonian(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z);
    double L1 = y*p3star - z*p2star;
    double L2 = z*p1star - x*p3star;
    double L3 = x*p2star - y*p1star;
    double Lnorm = sqrt(L1*L1 + L2*L2 + L3*L3);
    double xcrossdx1 = y*z_time_deriv - z*y_time_deriv;
    double xcrossdx2 = z*x_time_deriv - x*z_time_deriv;
    double xcrossdx3 = x*y_time_deriv - y*x_time_deriv;
    double omega = sqrt(xcrossdx1*xcrossdx1 + xcrossdx2*xcrossdx2 + xcrossdx3*xcrossdx3)*u2;
    double dedt = v4P_compute_flux(m1,m2,tortoise,x,y,z,p1star,p2star,p3star,S1x,S1y,S1z,S2x,S2y,S2z,omega,hamiltonian,1.)/eta;
    double invomegalnorm = 1/(omega*Lnorm);
    double pdotterm3_3 = invomegalnorm*dedt*p3star;
    double pdotterm3_2 = invomegalnorm*dedt*p2star;
    double pdotterm3_1 = invomegalnorm*dedt*p1star;
    double dpdx_11 = T11_xderiv1*p1 + T21_xderiv1*p2 + T31_xderiv1*p3;
    double dpdx_12 = T11_xderiv2*p1 + T21_xderiv2*p2 + T31_xderiv2*p3;
    double dpdx_13 = T11_xderiv3*p1 + T21_xderiv3*p2 + T31_xderiv3*p3;
    double dpdx_21 = T12_xderiv1*p1 + T22_xderiv1*p2 + T32_xderiv1*p3;
    double dpdx_22 = T12_xderiv2*p1 + T22_xderiv2*p2 + T32_xderiv2*p3;
    double dpdx_23 = T12_xderiv3*p1 + T22_xderiv3*p2 + T32_xderiv3*p3;
    double dpdx_31 = T13_xderiv1*p1 + T23_xderiv1*p2 + T33_xderiv1*p3;
    double dpdx_32 = T13_xderiv2*p1 + T23_xderiv2*p2 + T33_xderiv2*p3;
    double dpdx_33 = T13_xderiv3*p1 + T23_xderiv3*p2 + T33_xderiv3*p3;
    double pdotterm2_3 = dpdx_31*x_time_deriv + dpdx_32*y_time_deriv + dpdx_33*z_time_deriv;
    double pdotterm2_2 = dpdx_21*x_time_deriv + dpdx_22*y_time_deriv + dpdx_23*z_time_deriv;
    double pdotterm2_1 = dpdx_11*x_time_deriv + dpdx_12*y_time_deriv + dpdx_13*z_time_deriv;
    double pdotterm1_3 = -T31*x_hamiltonian_deriv - T32*y_hamiltonian_deriv - T33*z_hamiltonian_deriv;
    double pdotterm1_2 = -T21*x_hamiltonian_deriv - T22*y_hamiltonian_deriv - T23*z_hamiltonian_deriv;
    double pdotterm1_1 = -T11*x_hamiltonian_deriv - T12*y_hamiltonian_deriv - T13*z_hamiltonian_deriv;
    double p3star_time_deriv = pdotterm1_3 + pdotterm2_3 + pdotterm3_3;
    double p2star_time_deriv = pdotterm1_2 + pdotterm2_2 + pdotterm3_2;
    double p1star_time_deriv = pdotterm1_1 + pdotterm2_1 + pdotterm3_1;
    double S1x_time_deriv = S1y_hamiltonian_deriv*S1z - S1z_hamiltonian_deriv*S1y;
    double S1y_time_deriv = S1z_hamiltonian_deriv*S1x - S1x_hamiltonian_deriv*S1y;
    double S1z_time_deriv = S1x_hamiltonian_deriv*S1y - S1y_hamiltonian_deriv*S1x;
    double S2x_time_deriv = S2y_hamiltonian_deriv*S2z - S2z_hamiltonian_deriv*S2y;
    double S2y_time_deriv = S2z_hamiltonian_deriv*S2x - S2x_hamiltonian_deriv*S2y;
    double S2z_time_deriv = S2x_hamiltonian_deriv*S2y - S2y_hamiltonian_deriv*S2x;
    dvalues[0] = x_time_deriv;
    dvalues[1] = y_time_deriv;
    dvalues[2] = z_time_deriv;
    dvalues[3] = p1star_time_deriv;
    dvalues[4] = p2star_time_deriv;
    dvalues[5] = p3star_time_deriv;
    dvalues[6] = S1x_time_deriv;
    dvalues[7] = S1y_time_deriv;
    dvalues[8] = S1z_time_deriv;
    dvalues[9] = S2x_time_deriv;
    dvalues[10] = S2y_time_deriv;
    dvalues[11] = S2z_time_deriv;
    return GSL_SUCCESS;
}
