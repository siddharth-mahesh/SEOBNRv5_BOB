#include "mainv4pheader.h" 
int v4P_compute_csi_dcsi(double csi_and_dcsi[],double m1,double m2,int tortoise,double x,double y,double z,double p1,double p2,double p3,double S1x,double S1y,double S1z,double S2x,double S2y,double S2z){
    double EMgamma = 0.577215664901532860606512090082402431;
    double M=m1+m2;
    double mu=m1*m2/M;
    double eta=mu/M;
    double r=sqrt(x*x+y*y+z*z);
    double u=1/r;
    double sigmastar3=(m2/m1*S1z+m1/m2*S2z)/M/M;
    double sigmastar2 = (m2/m1*S1y + m1/m2*S2y)/M/M;
    double sigmastar1 = (m2/m1*S1x + m1/m2*S2x)/M/M;
    double sigma3=(S1z+S2z)/M/M;
    double sigma2 = (S1y + S2y)/M/M;
    double sigma1 = (S1x + S2x)/M/M;
    double Skerr3=sigma3;
    double Skerr2 = sigma2;
    double Skerr1 = sigma1;
    double Skerrmag=sqrt(Skerr1*Skerr1+Skerr2*Skerr2+Skerr3*Skerr3);
    double Skerrhat3=Skerr3/Skerrmag;
    double Skerrhat2 = Skerr2/Skerrmag;
    double Skerrhat1 = Skerr1/Skerrmag;
    double a=Skerrmag;
    double L3=x*p2-y*p1;
    double L2 = z*p1 - x*p3;
    double L1 = y*p3 - z*p2;
    double Lnorm=sqrt(L1*L1+L2*L2+L3*L3);
    double Lhat3=L3/Lnorm;
    double Lhat2 = L2/Lnorm;
    double Lhat1 = L1/Lnorm;
    double S2dotLhat=S2x*Lhat1+S2y*Lhat2+S2z*Lhat3;
    double S1dotLhat = S1x*Lhat1 + S1y*Lhat2 + S1z*Lhat3;
    double S1perp3=S1z-S1dotLhat*Lhat3;
    double S1perp2 = S1y - S1dotLhat*Lhat2;
    double S1perp1 = S1x - S1dotLhat*Lhat1;
    double S2perp3=S2z-S2dotLhat*Lhat3;
    double S2perp2 = S2y - S2dotLhat*Lhat2;
    double S2perp1 = S2x - S2dotLhat*Lhat1;
    double Sperp3=S1perp3+S2perp3;
    double Sperp2 = S1perp2 + S2perp2;
    double Sperp1 = S1perp1 + S2perp1;
    double n3=z/r;
    double n2 = y/r;
    double n1 = x/r;
    double TINYDOUBLE=1e-100;
    double condition_e3prov_lhs = a;
    double condition_e3prov_rhs = 1e-16;
    double e3prov_gt_bound = fdivide(1,2)*(condition_e3prov_lhs - condition_e3prov_rhs + fabs(condition_e3prov_lhs - condition_e3prov_rhs))/(condition_e3prov_lhs - condition_e3prov_rhs - TINYDOUBLE);
    double e3prov_leq_bound = fdivide(1,2)*(condition_e3prov_lhs - condition_e3prov_rhs - TINYDOUBLE - fabs(condition_e3prov_lhs - condition_e3prov_rhs - TINYDOUBLE))/(condition_e3prov_lhs - condition_e3prov_rhs - TINYDOUBLE);
    double e3prov1 = Skerrhat1*e3prov_gt_bound + e3prov_leq_bound/sqrt(3.);
    double e3prov2 = Skerrhat2*e3prov_gt_bound + e3prov_leq_bound/sqrt(3.);
    double e3prov3 = Skerrhat3*e3prov_gt_bound + e3prov_leq_bound/sqrt(3.);
    double lambdavec3=Lhat1*n2-Lhat2*n3;
    double lambdavec2 = Lhat3*n1 - Lhat1*n3;
    double lambdavec1 = Lhat2*n3 - Lhat3*n2;
    double lambdavecnorm=sqrt(lambdavec1*lambdavec1+lambdavec2*lambdavec2+lambdavec3*lambdavec3);
    double lambdahat3=lambdavec3/lambdavecnorm;
    double lambdahat2 = lambdavec2/lambdavecnorm;
    double lambdahat1 = lambdavec1/lambdavecnorm;
    double lambdahat_dot_e3prov=lambdahat1*e3prov1+lambdahat2*e3prov2+lambdahat3*e3prov3;
    double lambdahat_cross_e3prov3=lambdahat1*e3prov2-lambdahat2*e3prov1;
    double lambdahat_cross_e3prov2 = lambdahat3*e3prov1 - lambdahat1*e3prov3;
    double lambdahat_cross_e3prov1 = lambdahat2*e3prov3 - lambdahat3*e3prov2;
    double e3prov_dot_n=e3prov1*n1+e3prov2*n2+e3prov3*n3;
    double cos_0_1_deg=0.9999983800004374;
    double sin_0_1_deg = 0.0017999990280001574;
    double condition_e3_lhs = 1 - fabs(e3prov_dot_n);
    double condition_e3_rhs = 1e-8;
    double e3_gt_bound = fdivide(1,2)*(condition_e3_lhs - condition_e3_rhs + fabs(condition_e3_lhs - condition_e3_rhs))/(condition_e3_lhs - condition_e3_rhs - TINYDOUBLE);
    double e3_leq_bound = fdivide(1,2)*(condition_e3_lhs - condition_e3_rhs - TINYDOUBLE - fabs(condition_e3_lhs - condition_e3_rhs - TINYDOUBLE))/(condition_e3_lhs - condition_e3_rhs - TINYDOUBLE);
    double e31 = e3prov1*e3_gt_bound + (e3prov1*cos_0_1_deg + lambdahat_cross_e3prov1*sin_0_1_deg + lambdahat1*lambdahat_dot_e3prov*(1 - cos_0_1_deg))*e3_leq_bound;
    double e32 = e3prov2*e3_gt_bound + (e3prov2*cos_0_1_deg + lambdahat_cross_e3prov2*sin_0_1_deg + lambdahat2*lambdahat_dot_e3prov*(1 - cos_0_1_deg))*e3_leq_bound;
    double e33 = e3prov3*e3_gt_bound + (e3prov3*cos_0_1_deg + lambdahat_cross_e3prov3*sin_0_1_deg + lambdahat3*lambdahat_dot_e3prov*(1 - cos_0_1_deg))*e3_leq_bound;
    double xi3=e31*n2-e32*n1;
    double xi2 = -e31*n3 + e33*n1;
    double xi1 = e32*n3 - e33*n2;
    double v3=n1*xi2-n2*xi1;
    double v2 = n3*xi1 - n1*xi3;
    double v1 = n2*xi3 - n3*xi2;
    double costheta=e31*n1+e32*n2+e33*n3;
    double sin2theta=1-costheta*costheta;
    double xisq = sin2theta;
    double w2=a*a+r*r;
    double Sigma=r*r+a*a*costheta*costheta;
    double Dinv=1+log(1+6*eta*u*u+2*(26-3*eta)*eta*u*u*u);
    double Dinvprime = -u*u*(12*eta*u + 6*(26 - 3*eta)*eta*u*u)/(1 + 6*eta*u*u + 2*(26 - 3*eta)*eta*u*u*u);
    double omegatilde=2*a*r;
    double chi=(Skerr1*Lhat1+Skerr2*Lhat2+Skerr3*Lhat3)/(1-2*eta)+fdivide(1,2)*(Sperp1*Skerr1+Sperp2*Skerr2+Sperp3*Skerr3)/(Skerrmag*(1.-2.*eta));
    double Kchi0=267.788*eta*eta*eta-126.687*eta*eta+10.2573*eta+1.7336;
    double K=-59.1658*chi*chi*chi*eta*eta*eta-0.426958*chi*chi*chi*eta+1.43659*chi*chi*chi+31.1746*chi*chi*eta*eta*eta+6.16466*chi*chi*eta*eta-1.38086*chi*chi-27.5201*chi*eta*eta*eta+17.3736*chi*eta*eta+2.26831*chi*eta-1.62045*chi+Kchi0;
    double etaKminus1 = eta*K - 1;
    double Delta0=K*(eta*K-2);
    double Delta1=-2*etaKminus1*(K+Delta0);
    double Delta2=fdivide(1,2)*Delta1*(Delta1-4*etaKminus1)-a*a*etaKminus1*etaKminus1*Delta0;
    double Delta3=-fdivide(1,3)*Delta1*Delta1*Delta1+etaKminus1*Delta1*Delta1+Delta2*Delta1-2*etaKminus1*(Delta2-etaKminus1)-a*a*etaKminus1*etaKminus1*Delta1;
    double Delta4=fdivide(1,12)*(6*a*a*(Delta1*Delta1-2*Delta2)*etaKminus1*etaKminus1+3*Delta1*Delta1*Delta1*Delta1-8*etaKminus1*Delta1*Delta1*Delta1-12*Delta2*Delta1*Delta1+12*(2*etaKminus1*Delta2+Delta3)*Delta1+12*(fdivide(94,3)-fdivide(41,32)*M_PI*M_PI)*etaKminus1*etaKminus1+6*(Delta2*Delta2-4*Delta3*etaKminus1));
    double Delta5=etaKminus1*etaKminus1*(fdivide(-4237,60)+fdivide(128,5)*EMgamma+fdivide(2275,512)*M_PI*M_PI-fdivide(1,3)*a*a*(Delta1*Delta1*Delta1-3*Delta1*Delta2+3*Delta3)-(Delta1*Delta1*Delta1*Delta1*Delta1-5*Delta1*Delta1*Delta1*Delta2+5*Delta1*Delta2*Delta2+5*Delta1*Delta1*Delta3-5*Delta2*Delta3-5*Delta1*Delta4)/(5*etaKminus1*etaKminus1)+(Delta1*Delta1*Delta1*Delta1-4*Delta1*Delta1*Delta2+2*Delta2*Delta2+4*Delta1*Delta3-4*Delta4)/(2*etaKminus1)+fdivide(256,5)*log(2)+(fdivide(41,32)*M_PI*M_PI-fdivide(221,6))*eta);
    double Delta5l=etaKminus1*etaKminus1*fdivide(64,5);
    double logarg=u*(Delta1+u*(Delta2+u*(Delta3+u*(Delta4+u*(Delta5+Delta5l*log(u))))));
    double Deltaucalib = 1 + eta*(Delta0 + log(fabs(1 + logarg)));
    double Deltaucalibprime = -eta*u*u*(Delta1+u*(2*Delta2+u*(3*Delta3+u*(4*Delta4+u*(5*(Delta5+Delta5l*log(u)))))))/(1+logarg);
    double Deltaubar=a*a*u*u+(2*u+1/etaKminus1)/etaKminus1;
    double Deltaubarprime = -2*a*a*u*u*u - 2*u*u/(etaKminus1);
    double Deltau=fabs(Deltaubar*Deltaucalib);
    double Deltauprime = Deltaubarprime*Deltaucalib + Deltaubar*Deltaucalibprime;
    double Deltatprime=2*r*Deltau+r*r*Deltauprime;
    double Deltat=r*r*Deltau;
    double Deltar=Deltat*Dinv;
    double Deltarprime = Deltatprime*Dinv + Deltat*Dinvprime;
    double Lambdat=fabs(w2*w2-a*a*Deltat*sin2theta);
    double csi=sqrt(fabs(Deltar*Deltat))/w2;
    double csiprime = (Deltatprime*Deltar + Deltarprime*Deltat)/(2*sqrt(Deltar*Deltat)*w2) - 2.*r*sqrt(Deltat*Deltar)/(w2*w2);
    csi_and_dcsi[0] = csi;
    csi_and_dcsi[1] = csiprime;
    return 1;
}